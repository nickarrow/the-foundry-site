---
interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} | The Foundry</title>
    <link rel="icon" type="image/png" href={`${import.meta.env.BASE_URL}/favicon.png`} />
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}/styles/main.css`} />
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}/styles/iron-vault.css`} />
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}/pagefind/pagefind-ui.css`} />
  </head>
  <body>
    <div class="app">
      <slot />
    </div>
    <script is:inline>
      // Initialize Pagefind search after page loads
      window.addEventListener('DOMContentLoaded', function() {
        // Load Pagefind UI script dynamically
        var script = document.createElement('script');
        script.src = '/the-foundry-site/pagefind/pagefind-ui.js';
        script.onload = function() {
          new PagefindUI({
            element: '#search-container',
            showSubResults: true,
            showImages: false,
            resetStyles: false
          });
        };
        script.onerror = function() {
          // Pagefind not available - show fallback
          var container = document.getElementById('search-container');
          if (container) {
            container.innerHTML = '<input type="text" placeholder="Search..." disabled style="width:100%;padding:0.5rem 0.75rem;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-muted);font-size:0.9rem;cursor:not-allowed;" />';
          }
        };
        document.head.appendChild(script);
      });
    </script>
    <script>
      // Mobile sidebar toggle
      document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.querySelector('.sidebar-toggle');
        const sidebar = document.querySelector('.sidebar');
        
        toggle?.addEventListener('click', () => {
          sidebar?.classList.toggle('open');
        });
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768) {
            const target = e.target as HTMLElement;
            if (!sidebar?.contains(target) && !toggle?.contains(target)) {
              sidebar?.classList.remove('open');
            }
          }
        });
        
        // Restore folder states from localStorage
        const savedStates = JSON.parse(localStorage.getItem('sidebarFolderStates') || '{}');
        document.querySelectorAll('.nav-folder').forEach((folder, index) => {
          const title = folder.querySelector('.nav-folder-title')?.textContent?.trim() || index.toString();
          if (savedStates[title] === 'expanded') {
            folder.classList.remove('collapsed');
          } else if (savedStates[title] === 'collapsed') {
            folder.classList.add('collapsed');
          }
          // If no saved state, keep the default (collapsed)
        });
        
        // Save folder state on toggle
        function saveFolderStates() {
          const states: Record<string, string> = {};
          document.querySelectorAll('.nav-folder').forEach((folder, index) => {
            const title = folder.querySelector('.nav-folder-title')?.textContent?.trim() || index.toString();
            states[title] = folder.classList.contains('collapsed') ? 'collapsed' : 'expanded';
          });
          localStorage.setItem('sidebarFolderStates', JSON.stringify(states));
        }
        
        // Collapsible nav folders
        document.querySelectorAll('.nav-folder > .nav-folder-title').forEach(title => {
          title.addEventListener('click', () => {
            title.parentElement?.classList.toggle('collapsed');
            saveFolderStates();
            updateToggleIcon();
          });
        });
        
        // Toggle all folders button (single button that switches icons)
        const toggleBtn = document.querySelector('.toggle-all-folders');
        const iconExpand = toggleBtn?.querySelector('.icon-expand') as HTMLElement;
        const iconCollapse = toggleBtn?.querySelector('.icon-collapse') as HTMLElement;
        
        function updateToggleIcon() {
          const allFolders = document.querySelectorAll('.nav-folder');
          const allCollapsed = Array.from(allFolders).every(f => f.classList.contains('collapsed'));
          
          if (iconExpand && iconCollapse) {
            // Show expand icon when all are collapsed, collapse icon when any are expanded
            iconExpand.style.display = allCollapsed ? 'block' : 'none';
            iconCollapse.style.display = allCollapsed ? 'none' : 'block';
          }
        }
        
        toggleBtn?.addEventListener('click', () => {
          const allFolders = document.querySelectorAll('.nav-folder');
          const allCollapsed = Array.from(allFolders).every(f => f.classList.contains('collapsed'));
          
          if (allCollapsed) {
            // Expand all
            allFolders.forEach(folder => folder.classList.remove('collapsed'));
          } else {
            // Collapse all
            allFolders.forEach(folder => folder.classList.add('collapsed'));
          }
          
          updateToggleIcon();
          saveFolderStates();
        });
        
        // Update icon on initial load
        updateToggleIcon();
        
        // Auto-expand folders containing the active page
        const activeItem = document.querySelector('.nav-item.active');
        if (activeItem) {
          let parent = activeItem.parentElement;
          while (parent) {
            if (parent.classList.contains('nav-folder')) {
              parent.classList.remove('collapsed');
            }
            parent = parent.parentElement;
          }
          saveFolderStates();
          
          // Scroll active item into view
          activeItem.scrollIntoView({ block: 'center', behavior: 'instant' });
        }
        
        // Collapsible callouts - toggle on title click
        document.querySelectorAll('.callout.is-collapsible .callout-title').forEach(title => {
          title.addEventListener('click', () => {
            const callout = title.closest('.callout');
            const content = callout?.querySelector('.callout-content') as HTMLElement;
            const fold = callout?.querySelector('.callout-fold');
            
            if (callout && content) {
              const isCollapsed = callout.classList.toggle('is-collapsed');
              content.style.display = isCollapsed ? 'none' : 'block';
              fold?.classList.toggle('is-collapsed', isCollapsed);
            }
          });
          
          // Make title look clickable
          (title as HTMLElement).style.cursor = 'pointer';
        });
      });
    </script>
  </body>
</html>
