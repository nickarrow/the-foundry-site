---
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} | The Foundry</title>
    <link rel="icon" type="image/png" href={`${import.meta.env.BASE_URL}/favicon.png`} />
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}/styles/main.css`} />
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}/styles/iron-vault.css`} />
    <link rel="stylesheet" href={`${import.meta.env.BASE_URL}/pagefind/pagefind-ui.css`} />
    <ViewTransitions />
  </head>
  <body>
    <div class="app">
      <slot />
    </div>
    <script is:inline>
      // Initialize Pagefind search - runs once since sidebar persists
      function initPagefind() {
        if (document.querySelector('.pagefind-ui')) return; // Already initialized
        
        const script = document.createElement('script');
        script.src = '/the-foundry-site/pagefind/pagefind-ui.js';
        script.onload = function () {
          new PagefindUI({
            element: '#search-container',
            showSubResults: true,
            showImages: false,
            resetStyles: false,
          });
          const placeholder = document.querySelector('.search-placeholder');
          if (placeholder) {
            placeholder.remove();
          }
        };
        script.onerror = function () {
          const placeholder = document.querySelector('.search-placeholder input');
          if (placeholder) {
            placeholder.disabled = false;
            placeholder.style.cursor = 'text';
          }
        };
        document.head.appendChild(script);
      }
      
      // Update active nav item on navigation
      function updateActiveNavItem() {
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-item').forEach(item => {
          const href = item.getAttribute('href');
          const isActive = currentPath === href || currentPath === href + '/';
          item.classList.toggle('active', isActive);
        });
      }
      
      // Run on initial load
      document.addEventListener('DOMContentLoaded', function() {
        initPagefind();
        updateActiveNavItem();
      });
      
      // Run on View Transitions navigation
      document.addEventListener('astro:after-swap', function() {
        updateActiveNavItem();
      });
    </script>
    <script>
      // Helper function to update toggle button icon
      function updateToggleIcon() {
        const toggleBtn = document.querySelector('.toggle-all-folders');
        const iconExpand = toggleBtn?.querySelector('.icon-expand') as HTMLElement;
        const iconCollapse = toggleBtn?.querySelector('.icon-collapse') as HTMLElement;
        
        const allFolders = document.querySelectorAll('.nav-folder');
        const allCollapsed = Array.from(allFolders).every((f) =>
          f.classList.contains('collapsed')
        );

        if (iconExpand && iconCollapse) {
          iconExpand.style.display = allCollapsed ? 'block' : 'none';
          iconCollapse.style.display = allCollapsed ? 'none' : 'block';
        }
      }

      // Helper function to expand folders containing active item and scroll to it
      function expandToActiveAndScroll() {
        const activeItem = document.querySelector('.nav-item.active');
        if (activeItem) {
          let parent = activeItem.parentElement;
          while (parent) {
            if (parent.classList.contains('nav-folder')) {
              parent.classList.remove('collapsed');
            }
            parent = parent.parentElement;
          }
          updateToggleIcon();
          activeItem.scrollIntoView({ block: 'center', behavior: 'instant' });
        }
      }

      // Sidebar initialization - runs once on first load (or hard refresh)
      // View Transitions preserves sidebar state across navigations
      function initSidebar() {
        const sidebar = document.querySelector('.sidebar');
        if (!sidebar) return;
        
        // If already initialized (sidebar persisted via View Transitions),
        // just expand to active item and scroll
        if (sidebar.dataset.initialized === 'true') {
          expandToActiveAndScroll();
          return;
        }
        sidebar.dataset.initialized = 'true';

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768) {
            const target = e.target as HTMLElement;
            const mobileHeader = document.querySelector('.mobile-header');
            if (!sidebar?.contains(target) && !mobileHeader?.contains(target)) {
              sidebar?.classList.remove('open');
            }
          }
        });

        // Set up click handlers for collapsible nav folders
        document.querySelectorAll('.nav-folder > .nav-folder-title').forEach((title) => {
          title.addEventListener('click', () => {
            title.parentElement?.classList.toggle('collapsed');
            updateToggleIcon();
          });
        });

        // Set up toggle all folders button
        const toggleBtn = document.querySelector('.toggle-all-folders');
        toggleBtn?.addEventListener('click', () => {
          const allFolders = document.querySelectorAll('.nav-folder');
          const allCollapsed = Array.from(allFolders).every((f) =>
            f.classList.contains('collapsed')
          );

          if (allCollapsed) {
            allFolders.forEach((folder) => folder.classList.remove('collapsed'));
          } else {
            allFolders.forEach((folder) => folder.classList.add('collapsed'));
          }

          updateToggleIcon();
        });

        // Initial UI setup
        updateToggleIcon();
        expandToActiveAndScroll();
      }

      // Collapsible callouts - needs to run on each page
      function initCallouts() {
        document.querySelectorAll('.callout.is-collapsible .callout-title').forEach((title) => {
          if ((title as HTMLElement).dataset.initialized === 'true') return;
          (title as HTMLElement).dataset.initialized = 'true';
          
          title.addEventListener('click', () => {
            const callout = title.closest('.callout');
            const content = callout?.querySelector('.callout-content') as HTMLElement;
            const fold = callout?.querySelector('.callout-fold');

            if (callout && content) {
              const isCollapsed = callout.classList.toggle('is-collapsed');
              content.style.display = isCollapsed ? 'none' : 'block';
              fold?.classList.toggle('is-collapsed', isCollapsed);
            }
          });

          (title as HTMLElement).style.cursor = 'pointer';
        });
      }

      // Run on initial load
      document.addEventListener('DOMContentLoaded', () => {
        initSidebar();
        initCallouts();
      });
      
      // Run on View Transitions navigation
      document.addEventListener('astro:after-swap', () => {
        initSidebar();
        initCallouts();
      });
    </script>
  </body>
</html>
