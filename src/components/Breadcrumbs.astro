---
import { getAllContentFiles, buildNavigationTree, type NavNode } from '../lib/content';

interface Props {
  slug: string;
}

const { slug } = Astro.props;
const base = import.meta.env.BASE_URL;

// Get all valid page slugs and build a slug-to-name map
const allFiles = getAllContentFiles();
const validSlugs = new Set(allFiles.map((f) => f.slug));

// Build a map of slug -> display name from the navigation tree
const navTree = buildNavigationTree();
const slugToName = new Map<string, string>();

function mapNavNodes(nodes: NavNode[]) {
  for (const node of nodes) {
    if (node.slug) {
      slugToName.set(node.slug, node.name);
    }
    if (node.children.length > 0) {
      mapNavNodes(node.children);
    }
  }
}
mapNavNodes(navTree);

// Build breadcrumb trail from slug
const parts = slug ? slug.split('/').filter((p) => p) : [];
const crumbs: { name: string; href: string | null }[] = [{ name: 'Home', href: base }];

let currentPath = '';
for (const part of parts) {
  currentPath += (currentPath ? '/' : '') + part;

  // Look up the actual name from the nav tree, fall back to slug conversion
  let name = slugToName.get(currentPath);
  if (!name) {
    // Fallback: convert slug back to readable name
    name = part
      .split('-')
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ')
      .replace(/\d+\.\s*/, '');
  }

  // Only make it a link if there's an actual page at this path
  const href = validSlugs.has(currentPath) ? `${base}/${currentPath}` : null;
  crumbs.push({ name, href });
}
---

<nav class="breadcrumbs" aria-label="Breadcrumb">
  <ol>
    {
      crumbs.map((crumb, i) => (
        <li>
          {i < crumbs.length - 1 ? (
            <>
              {crumb.href ? (
                <a href={crumb.href}>{crumb.name}</a>
              ) : (
                <span class="folder">{crumb.name}</span>
              )}
              <span class="separator">/</span>
            </>
          ) : (
            <span class="current">{crumb.name}</span>
          )}
        </li>
      ))
    }
  </ol>
</nav>

<style>
  .breadcrumbs {
    font-size: 0.85rem;
    margin-bottom: 1rem;
    color: var(--text-muted);
    position: sticky;
    top: 0;
    background: var(--bg-primary);
    padding: 0.5rem 0;
    margin: -0.5rem 0 1rem 0;
    z-index: 50;
    backdrop-filter: blur(8px);
    background: rgba(30, 30, 30, 0.9);
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
  }

  .breadcrumbs.scrolled {
    border-bottom-color: var(--border-color);
  }

  /* Hide on mobile - MobileHeader handles breadcrumbs there */
  @media (max-width: 768px) {
    .breadcrumbs {
      display: none;
    }
  }

  ol {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 0.25rem;
  }

  li {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  a {
    color: var(--link-color);
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  .separator {
    color: var(--text-muted);
    opacity: 0.5;
  }

  .folder {
    color: var(--text-secondary);
  }

  .current {
    color: var(--text-primary);
  }
</style>

<script>
  // Add scrolled class to breadcrumbs when page is scrolled
  const breadcrumbs = document.querySelector('.breadcrumbs');
  if (breadcrumbs) {
    const observer = new IntersectionObserver(
      ([entry]) => {
        breadcrumbs.classList.toggle('scrolled', !entry.isIntersecting);
      },
      { threshold: 1, rootMargin: '-1px 0px 0px 0px' }
    );

    // Create a sentinel element at the top of the content
    const sentinel = document.createElement('div');
    sentinel.style.height = '1px';
    sentinel.style.position = 'absolute';
    sentinel.style.top = '0';
    breadcrumbs.parentElement?.insertBefore(sentinel, breadcrumbs);
    observer.observe(sentinel);
  }
</script>
